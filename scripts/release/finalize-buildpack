#!/usr/bin/env ruby
require 'digest'
require 'fileutils'

Dir.chdir('pivotal-buildpacks-cached') do
  Dir.glob("*.zip").map do |filename|
    filename.match(/(.*)_buildpack-cached-v(.*)\+.*.zip/) do |match|
      _, language, version = match.to_a
      new_filename = "#{language}_buildpack-cached-v#{version}.zip"
      sha_filename = "#{new_filename}.SHA256SUM.txt"

      FileUtils.mv(filename, new_filename)

      shasum = Digest::SHA256.file(new_filename).hexdigest
      File.write(sha_filename, "#{shasum} #{new_filename}")

      # append SHA to RELEASE NOTES
      File.write('../prepare-release/buildpack/RECENT_CHANGES', "  * SHA256: #{shasum}",mode: 'a')

      # commit to buildpack checksums
      FileUtils.cp(sha_filename, '../buildpack-checksums-master')
      Dir.chdir('../buildpack-checksums-master') do
        system <<-eof
          git add -A
          git commit -m "SHA256SUM for #{language} v#{version}"
          ./generate.rb ../buildpack-checksums-gh-pages
        eof
      end

      # commit static site buildpack checksums
      Dir.chdir('../buildpack-checksums-gh-pages') do
        system <<-eof
          git add -A
          git commit -m "Updates for #{language} v#{version}"
        eof
      end
    end
  end
end
