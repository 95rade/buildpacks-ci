#!/usr/bin/env ruby
require "fileutils"

Dir.chdir('pivotal-buildpacks-cached') do
  Dir.glob("*.zip").map do |filename|
    filename.match(/(.*)_buildpack-cached-v(.*)\+.*.zip/) do |match|
      language = match[1]
      version = match[2]
      FileUtils.mv(filename, "#{language}_buildpack-cached-v#{version}.zip")

      system <<-eof
        sha256sum #{language}_buildpack-cached-v#{version}.zip > #{language}_buildpack-cached-v#{version}.zip.SHA256SUM.txt
        echo "  * SHA256: `sha256sum #{language}_buildpack-cached-v#{version}.zip | cut -d ' ' -f 1` " >> ../prepare-release/buildpack/RECENT_CHANGES
        cp #{language}_buildpack-cached-v#{version}.zip.SHA256SUM.txt ../buildpack-checksums-master
        cd ../buildpack-checksums-master
        git add -A
        git commit -m "SHA256SUM for #{language} v#{version}"
        ./generate.rb
        mv build ../buildpack-checksums-gh-pages
        cd ../buildpack-checksums-gh-pages
        git add -A
        git commit -m "Updates for #{language} v#{version}"
      eof
    end
  end
end
