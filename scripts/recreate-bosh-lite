#!/bin/bash -l

set -eux

cd deployments-buildpacks
bundle install -j4
. ./bin/switch $DEPLOYMENT_NAME --no-target

cd deployments/$DEPLOYMENT_NAME
rm -f .vagrant/machines/default/aws/elastic_ip
vagrant destroy -f
vagrant up --provider=aws

git add -A
git commit -m "recreated deployment $DEPLOYMENT_NAME"

unset $(env | grep BOSH_ | cut -d '=' -f 1)
bosh target $DEPLOYMENT_NAME.cf-app.com
bosh login admin admin
bosh create user admin $BOSH_LITE_PASSWORD

rm manifest.yml
git add -A
git commit -m "remove deployment manifest for $DEPLOYMENT_NAME"
