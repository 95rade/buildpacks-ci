#!/usr/bin/env ruby
# encoding: utf-8

fail '`brew install lastpass-cli` is required' if `which lpass` == ''

def header(msg)
  puts '*' * 80
  puts msg
  puts '*' * 80
end

header('For standard pipelines')
Dir['pipelines/*.yml'].each do |filename|
  name = File.basename(filename, '.yml')
  puts "   #{name} pipeline"
  system("erb #{filename} > /tmp/pipeline.yml")
  system(%{bash -c "fly -t buildpacks set-pipeline -p #{name} -c /tmp/pipeline.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes)"})
end

header('For bosh-lite pipelines')
Dir['config/bosh-lite/*.yml'].each do |filename|
  deployment_name = File.basename(filename, '.yml')
  puts "   #{deployment_name} bosh-lite"
  system("erb deployment_name=#{deployment_name} pipelines/templates/bosh-lite.yml > /tmp/pipeline.yml")
  system(%{bash -c "fly -t buildpacks set-pipeline -p #{deployment_name} -c /tmp/pipeline.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes) -l #{filename}"})
end

header('For buildpack pipelines')
Dir['config/buildpack/*.yml'].each do |filename|
  language = File.basename(filename, '.yml')
  puts "   #{language} buildpack"
  system("erb language=#{language} pipelines/templates/buildpack.yml > /tmp/pipeline.yml")
  system(%{bash -c "fly -t buildpacks set-pipeline -p #{language}-buildpack -c /tmp/pipeline.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes) -l #{filename}"})
end

header('For buildpack pull request pipelines')
Dir['config/buildpack/*.yml'].each do |filename|
  language = File.basename(filename, '.yml')
  puts "   #{language} pull-request"
  system("erb language=#{language} pipelines/templates/pull-request.yml > /tmp/pipeline.yml")
  system(%{bash -c "fly -t buildpacks set-pipeline -p #{language}-pull-request -c /tmp/pipeline.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes) -l #{filename}"})
end

puts 'Thanks, JT'
