#!/usr/bin/env ruby

raise '`brew install lastpass-cli` is required' if `which lpass` == ''

Dir["pipelines/*.yml"].each do |filename|
  name = File.basename(filename, '.yml')
  system(%Q{bash -c "fly -t buildpacks set-pipeline -p #{name} -c pipelines/#{name}.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes)"})
end

Dir["config/bosh-lite/*.yml"].each do |filename|
  deployment_name = File.basename(filename, '.yml')
  system(%Q{bash -c "fly -t buildpacks set-pipeline -p #{deployment_name} -c pipelines/templates/bosh-lite.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes) -l #{filename}"})
end

Dir["config/buildpack/*.yml"].each do |filename|
  language = File.basename(filename, '.yml')
  system("erb language=#{language} pipelines/templates/buildpack.yml > /tmp/pipeline.yml")
  system(%Q{bash -c "fly -t buildpacks set-pipeline -p #{language}-buildpack -c /tmp/pipeline.yml -l <(lpass show 'Shared-Buildpacks/concourse-private.yml' --notes) -l #{filename}"})
end

puts "Thanks, JT"
