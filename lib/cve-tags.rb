require 'rss'
require 'nokogiri'

class CVETags

  attr_reader :stacks_dir

  def initialize(stacks_dir)
    @stacks_dir = stacks_dir
  end

  def related_cves
    raise "cflinuxfs2/cflinuxfs2_receipt not found in '#{@stacks_dir}'" unless receipt_found
    return [] unless rss

    @related_cves ||= rss.items.select do |item|
      description = Nokogiri::HTML(item.description) { |c| c.options = Nokogiri::XML::ParseOptions::NOBLANKS }
      header      = description.css('dt').find { |dt| dt.text.include?('Ubuntu 14.04') }

      if header
        sibling     = header.css('+ dd')
        libs        = []

        while sibling
          libs << [
            sibling.css('> a').text,
            sibling.css('> span a').text
          ]
          sibling = sibling.css('+ dd').first
        end

        libs.any? do |name, version|
          find_vulnerability_in_receipt("#{name}")
        end
      end
    end.map do |item|
      {
        title: item.title.chomp,
        description: Nokogiri::HTML(item.description).text.chomp
      }
    end
  end

  private

  def feed_uri
    'http://www.ubuntu.com/usn/rss.xml'
  end

  def rss
    @rss ||= RSS::Parser.parse(feed_uri, false)
  end

  def receipt_found
    File.exists? "#{@stacks_dir}/cflinuxfs2/cflinuxfs2_receipt"
  end

  def find_vulnerability_in_receipt(regex)
    Dir.chdir(@stacks_dir) do
      open("cflinuxfs2/cflinuxfs2_receipt", 'r').grep(/#{regex}/).length > 0
    end
  end
end
