resources:
  - name: binary-builder
    type: git
    source:
      uri: https://github.com/cloudfoundry/binary-builder.git
  - name: binary-builder-compiler-cache
    type: s3
    source:
      bucket: pivotal-buildpacks
      versioned_file: ccache.tgz
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: buildpacks-ci
    type: git
    source:
      uri: https://github.com/cloudfoundry/buildpacks-ci
  - name: builds-out
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
  - name: nginx-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ nginx-builds.yml ]
  - name: php-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ php-builds.yml ]
  - name: node-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ node-builds.yml ]
  - name: ruby-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ ruby-builds.yml ]
  - name: jruby-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ jruby-builds.yml ]
  - name: httpd-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ httpd-builds.yml ]
  - name: python-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ python-builds.yml ]
  - name: build-tar 
    type: s3
    source:
      bucket: pivotal-buildpacks
      versioned_file: /concourse-artifacts/binary-builder-source.tgz
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: godep-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ godep-builds.yml ]

jobs:
  - name: binary-builder
    serial: true
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: binary-builder
          trigger: true
        - get: binary-builder-compiler-cache
      - task: rspec
        config:
          platform: linux
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: binary-builder
            - name: buildpacks-ci
            - name: binary-builder-compiler-cache
          run:
            path: buildpacks-ci/scripts/binary-builder.sh
        privileged: true
      - put: binary-builder-compiler-cache
        params:
          from: rspec/ccache.tgz
  - name: build-php
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: php-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: php
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: php
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-jruby
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: jruby-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: jruby
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: jruby
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-httpd
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: httpd-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: httpd
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: httpd
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-python
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: python-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: python
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: python
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-ruby
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: ruby-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: ruby
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: ruby
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-nodejs
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: node-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: node
        privileged: true
      - put: build-tar
        params:
          from: build-binary/binary-builder/build.tgz
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: node
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: test-nodejs
    serial: true
    plan:
      - get: build-tar
        passed: [ build-nodejs ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c", "tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/node/*/*/ && make test"]

  - name: build-nginx
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: nginx-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: nginx
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: nginx
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
  - name: build-godep
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: godep-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - task: build-binary
        file: buildpacks-ci/tasks/build-binary.yml
        config:
          params:
            BINARY_NAME: godep
        privileged: true
      - task: push-binary
        file: buildpacks-ci/tasks/push-binary.yml
        config:
          params:
            BINARY_NAME: godep
            AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
            AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
            AWS_DEFAULT_REGION: us-east-1
        privileged: true
      - put: builds-out
        params:
          repository: build-binary/builds-yaml
          rebase: true
