resources:
  - name: binary-builder
    type: git
    source:
      uri: https://github.com/cloudfoundry/binary-builder.git
  - name: binary-builder-compiler-cache
    type: s3
    source:
      bucket: pivotal-buildpacks
      versioned_file: ccache.tgz
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: buildpacks-ci
    type: git
    source:
      uri: https://github.com/cloudfoundry/buildpacks-ci
  - name: builds-out
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
  - name: nginx-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ nginx-builds.yml ]
  - name: php-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ php-builds.yml ]
  - name: node-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ node-builds.yml ]
  - name: ruby-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ ruby-builds.yml ]
  - name: jruby-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ jruby-builds.yml ]
  - name: httpd-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ httpd-builds.yml ]
  - name: python-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ python-builds.yml ]
  - name: build-tar
    type: s3
    source:
      bucket: pivotal-buildpacks
      versioned_file: /concourse-artifacts/binary-builder-source.tgz
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}
  - name: godep-builds
    type: git
    source:
      branch: binary-builds
      private_key: {{buildpacks-ci-binary-builds-private-key}}
      uri: git@github.com:cloudfoundry/buildpacks-ci.git
      paths: [ godep-builds.yml ]
  - name: concourse2tracker
    type: concourse2tracker
  - name: failure-alert
    type: slack-notification
    source:
      url: {{concourse-job-failure-notifications-slack-webhook}}
jobs:
  - name: binary-builder
    serial: true
    plan:
      - aggregate:
        - get: buildpacks-ci
        - get: binary-builder
          trigger: true
        - get: binary-builder-compiler-cache
      - do:
        - task: rspec
          config:
            platform: linux
            image: docker:///cloudfoundry/cflinuxfs2
            inputs:
              - name: binary-builder
              - name: buildpacks-ci
              - name: binary-builder-compiler-cache
            run:
              path: buildpacks-ci/scripts/binary-builder.sh
          privileged: true
        - put: binary-builder-compiler-cache
          params:
            from: rspec/ccache.tgz
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder binary-builder job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/binary-builder"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: build-php
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: php-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: php
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: php
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-php job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-php"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-php
    serial: true
    plan:
      - get: build-tar
        passed: [ build-php ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c", "apt-get update &&
              apt-get install -y automake \
              libaspell-dev \
              libc-client2007e-dev \
              libcurl4-openssl-dev \
              libexpat1-dev \
              libgdbm-dev \
              libgmp-dev \
              libjpeg-dev \
              libldap2-dev \
              libmcrypt-dev \
              libmemcached-dev \
              libpng12-dev \
              libpspell-dev \
              libreadline-dev \
              libsasl2-dev \
              libsnmp-dev \
              libsqlite3-dev \
              libssl-dev \
              libzip-dev \
              libzookeeper-mt-dev \
              mercurial \
              snmp-mibs-downloader &&
              tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/php/*/*/ && yes n | env REPORT_EXIT_STATUS=1 make test"]
  - name: build-jruby
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: jruby-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: jruby
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: jruby
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-jruby job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-jruby"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-jruby
    serial: true
    plan:
      - get: build-tar
        passed: [ build-jruby ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c",
              "apt-get update &&
              apt-get install -y openjdk-7-jdk maven ant &&
              tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/jruby/*/*/ &&
              export JAVA_OPTS='-XX:+TieredCompilation -XX:TieredStopAtLevel=1' &&
              export MALLOC_ARENA_MAX=2 &&
              export PHASE='-Ptest' &&
              mvn -Pbootstrap clean install -Dinvoker.skip -Dmaven.test.skip &&
              mvn install -Dinvoker.skip=false $PHASE"]
  - name: build-httpd
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: httpd-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: httpd
          privileged: true
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: httpd
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-httpd job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-httpd"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: build-python
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: python-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: python
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: python
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-python job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-python"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-python
    serial: true
    plan:
      - get: build-tar
        passed: [ build-python ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c", "tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/python/*/*/ && make test"]
  - name: build-ruby
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: ruby-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: ruby
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: ruby
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-ruby job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-ruby"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-ruby
    serial: true
    plan:
      - get: build-tar
        passed: [ build-ruby ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c", "tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/ruby/*/*/ && make test"]
  - name: build-nodejs
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: node-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: node
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: node
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-nodejs job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-nodejs"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-nodejs
    serial: true
    plan:
      - get: build-tar
        passed: [ build-nodejs ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c", "tar xzf build-tar/binary-builder-source.tgz -C /tmp &&
              cd /tmp/x86_64-linux-gnu/ports/node/*/*/ && make test"]

  - name: build-nginx
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: nginx-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: nginx
          privileged: true
        - put: build-tar
          params:
            from: build-binary/binary-builder/build.tgz
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: nginx
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-nginx job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-nginx"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
  - name: test-nginx
    serial: true
    plan:
      - get: build-tar
        passed: [ build-nginx ]
        trigger: true
      - task: run tests
        config:
          image: docker:///cloudfoundry/cflinuxfs2
          inputs:
            - name: build-tar
          platform: linux
          run:
            path: bash
            args: ["-c",
              "wget http://hg.nginx.org/nginx-tests/archive/tip.tar.gz &&
              tar -xzf tip.tar.gz -C /tmp/ &&
              tar xzf build-tar/binary-builder-source.tgz -C /tmp/ &&
              cd /tmp/nginx-tests* &&
              TEST_NGINX_BINARY=`ls /tmp/x86_64-linux-gnu/ports/nginx/*/nginx-*/objs/nginx` prove ."]
  - name: build-godep
    serial: true
    plan:
      - aggregate:
        - get: builds-yaml
          resource: godep-builds
          trigger: true
        - get: binary-builder
          passed: [binary-builder]
        - get: buildpacks-ci
      - do:
        - task: build-binary
          file: buildpacks-ci/tasks/build-binary.yml
          config:
            params:
              BINARY_NAME: godep
          privileged: true
        - task: push-binary
          file: buildpacks-ci/tasks/push-binary.yml
          config:
            params:
              BINARY_NAME: godep
              AWS_ACCESS_KEY_ID: {{pivotal-buildpacks-s3-access-key}}
              AWS_SECRET_ACCESS_KEY: {{pivotal-buildpacks-s3-secret-key}}
              AWS_DEFAULT_REGION: us-east-1
          privileged: true
        - put: builds-out
          params:
            repository: build-binary/builds-yaml
            rebase: true
        - put: concourse2tracker
          params:
            api_token: {{pivotal-tracker-api-token}}
            git_path: builds-yaml
            project_id: {{cf-buildpacks-public-tracker-id}}
        on_failure:
          put: failure-alert
          params:
            text: "binary-builder build-godep job on Concourse failed! \n Check: https://buildpacks.ci.cf-app.com/pipelines/binary-builder/jobs/build-godep"
            channel: {{concourse-job-failure-notifications-slack-channel}}
            username: concourse
            icon_url: http://cl.ly/image/3e1h0H3H2s0P/concourse-logo.png
