---
resource_types:
  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
  - name: bosh-deployment
    type: docker-image
    source:
      repository: cloudfoundry/bosh-deployment-resource
resources: ###########################################################################################################
  - name: cf-deployment-concourse-tasks
    type: git
    source:
      branch: master
      uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
      tag_filter: v4.*
  - name: bbl-state
    type: git
    source:
      uri: git@github.com:cloudfoundry/buildpacks-envs
      branch: master
      private_key: {{buildpacks-envs-private-key}}
  - name: bosh-deployment
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-deployment
      branch: bosh-lite-safe
  - name: cf-deployment-rc
    type: git
    source:
      uri: https://github.com/cloudfoundry/cf-deployment
      branch: release-candidate
  - name: buildpacks-ci
    type: git
    source:
      uri: {{buildpacks-ci-git-uri-public}}
      branch: credhub-assist-buildpack #{{buildpacks-ci-git-uri-public-branch}}
  - name: bosh-lite
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-lite
  - name: credhub-assist-buildpack-cf-deployment
    type: bosh-deployment
    source:
      deployment: cf
      vars_store:
        provider: gcs
        config:
          bucket: credhub-assist-buildpack-cf-deployment
          file_name: vars-store.yml
          json_key: {{credhub-assist-buildpack-cf-deployment-gcs-service-account-key}}
  - name: lite-stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-warden-boshlite-ubuntu-trusty-go_agent
jobs: ################################################################################################################
  - name: bbl-up-bosh-lite
    serial: true
    serial_groups: [ credhub-assist-buildpack ]
    public: true
    plan:
      - aggregate:
        - get: cf-deployment-concourse-tasks
        - get: bbl-state
        - get: bosh-deployment
      - task: bbl-up
        file: cf-deployment-concourse-tasks/bbl-up/task.yml
        params:
          BBL_GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
          BBL_GCP_PROJECT_ID: cf-buildpacks
          BBL_GCP_ZONE: us-east1-c
          BBL_GCP_REGION: us-east1
          BBL_IAAS: gcp
          BBL_LB_CERT: {{credhub-assist-buildpack-lb-cert}}
          BBL_LB_KEY: {{credhub-assist-buildpack-lb-key}}
          LB_DOMAIN: credhub-assist-buildpack.buildpacks-gcp.ci.cf-app.com
          BBL_ENV_NAME: credhub-assist-buildpack
          BBL_STATE_DIR: credhub-assist-buildpack
          OPS_FILES: "bosh-lite.yml bosh-lite-runc.yml gcp/bosh-lite-vm-type.yml"
          IS_BOSH_LITE: true
        input_mapping:
          ops-files: bosh-deployment
        ensure:
          put: bbl-state
          params:
            repository: updated-bbl-state
            rebase: true

  - name: bosh-lite-gcp-networking
    serial: true
    serial_groups: [ credhub-assist-buildpack ]
    public: true
    plan:
      - aggregate:
        - get: bbl-state
        - get: buildpacks-ci
      - task: add-firewall-rule
        file: buildpacks-ci/tasks/add-bosh-lite-gcp-firewall-rule/task.yml
        params:
          GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
          ENV_NAME: credhub-assist-buildpack
      - task: add-dns-zone
        file: buildpacks-ci/tasks/add-gcp-bosh-lite-dns-zone/task.yml
        params:
          GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
          ENV_NAME: credhub-assist-buildpack

  # - name: bbl-destroy-bosh-lite
  #   serial: true
  #   serial_groups: [ credhub-assist-buildpack ]
  #   public: true
  #   plan:
  #     - aggregate:
  #       - get: deployments-buildpacks
  #         passed: [ cats ]
  #         trigger: true
  #       - get: cf-deployment-concourse-tasks
  #       - get: bbl-state
  #       - get: buildpacks-ci
  #     - task: remove-firewall-rule
  #       file: buildpacks-ci/tasks/remove-bosh-lite-gcp-firewall-rule/task.yml
  #       params:
  #         GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
  #         ENV_NAME: credhub-assist-buildpack
  #     - task: remove-gcp-bosh-lite-dns-zone
  #       file: buildpacks-ci/tasks/remove-gcp-bosh-lite-dns-zone/task.yml
  #       params:
  #         GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
  #         ENV_NAME: credhub-assist-buildpack
  #     - task: bbl-destroy
  #       file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
  #       params:
  #         BBL_STATE_DIR: credhub-assist-buildpack
  #         BBL_GCP_PROJECT_ID: cf-buildpacks
  #         BBL_GCP_SERVICE_ACCOUNT_KEY: {{gcp-service-account-key}}
  #       ensure:
  #         put: bbl-state
  #         params:
  #           repository: updated-bbl-state
  #           rebase: true

